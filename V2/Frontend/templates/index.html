<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Record and Process Audio</title>
</head>
<body>
    <h2>Record and Process Audio</h2>

    <!-- Buttons to control recording -->
    <button onclick="startRecording()">Start Recording</button>
    <button onclick="stopRecording()" disabled id="stopButton">Stop Recording</button>

    <!-- Audio player for recorded audio -->
    <h3>Recorded Audio</h3>
    <audio id="recordedAudio" controls></audio>

    <!-- Audio player for processed audio -->
    <h3>Processed Audio</h3>
    <audio id="processedAudio" controls></audio>

    <script>
        let mediaRecorder;
        let audioChunks = [];

        async function startRecording() {
            // Request microphone access
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);

            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                audioChunks = []; // Reset for next recording

                // Play recorded audio
                const recordedAudio = document.getElementById("recordedAudio");
                recordedAudio.src = URL.createObjectURL(audioBlob);

                // Automatically upload audio for processing
                await uploadAudio(audioBlob);
            };

            mediaRecorder.start();
            document.getElementById("stopButton").disabled = false;
        }

        function stopRecording() {
            mediaRecorder.stop();
            document.getElementById("stopButton").disabled = true;
        }

        async function uploadAudio(audioBlob) {
            const formData = new FormData();
            formData.append("audio", audioBlob, "recording.wav");

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error("Failed to process audio.");

                const processedBlob = await response.blob();
                const processedAudio = document.getElementById("processedAudio");
                processedAudio.src = URL.createObjectURL(processedBlob);
                processedAudio.play();

            } catch (error) {
                console.error(error);
                alert("An error occurred while processing the audio.");
            }
        }
    </script>
</body>
</html>
